<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura Extrema BLE Huawei Watch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; }
        .log { font-size: 0.95em; font-family: monospace; background: #18181b; color: #e5e7eb; max-height: 200px; overflow-y: auto; padding: 1em; border-radius: 10px;}
    </style>
</head>
<body class="bg-black min-h-screen flex flex-col items-center justify-center p-6">

    <div class="w-full max-w-lg bg-gray-900 rounded-2xl shadow-lg p-8 space-y-6 text-center">
        <h1 class="text-2xl font-bold text-white mb-2">Lectura Extrema BLE</h1>
        <p class="text-gray-400 mb-2">Lee todos los servicios disponibles (Huawei Watch BLE)</p>
        <div class="border border-gray-700 rounded-lg p-5 bg-gray-800 space-y-2">
            <div>
                <span class="font-semibold text-gray-300">Heart Rate: </span>
                <span id="heartRate" class="text-3xl text-pink-400 font-extrabold">--</span> <span class="text-gray-400">BPM</span>
            </div>
            <div>
                <span class="font-semibold text-gray-300">Batería: </span>
                <span id="batteryLevel" class="text-2xl text-green-300 font-bold">--</span> <span class="text-gray-400">%</span>
            </div>
        </div>
        <div>
            <button id="connectBtn" class="w-full bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:bg-gray-600">
                Conectar y Leer Todo
            </button>
        </div>
        <div id="status" class="mt-2 text-sm text-gray-300"></div>
        <div class="mt-5 text-left">
            <div class="text-gray-400 mb-1">Log de datos crudos recibidos:</div>
            <div id="logRaw" class="log"></div>
        </div>
    </div>

    <script>
        const connectBtn = document.getElementById('connectBtn');
        const status = document.getElementById('status');
        const logRaw = document.getElementById('logRaw');
        const heartRateElem = document.getElementById('heartRate');
        const batteryLevelElem = document.getElementById('batteryLevel');

        let logLines = [];

        function appendLog(text) {
            logLines.push(text);
            if (logLines.length > 80) logLines.shift();
            logRaw.innerText = logLines.join('\n');
        }

        connectBtn.onclick = async () => {
            connectBtn.disabled = true;
            status.textContent = 'Buscando dispositivo BLE...';

            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }],
                    optionalServices: [
                        'battery_service', 
                        0x3802, 
                        0xfe86,
                        'device_information',
                        'generic_access',
                        'generic_attribute',
                        '0000180f-0000-1000-8000-00805f9b34fb', // battery_service
                        '0000180d-0000-1000-8000-00805f9b34fb', // heart_rate
                        'cc353442-be58-4ea2-876e-11d8d6976366'
                    ]
                });

                status.textContent = 'Conectando...';
                const server = await device.gatt.connect();

                // ====== Heart Rate ======
                try {
                    const hrService = await server.getPrimaryService('heart_rate');
                    const hrChar = await hrService.getCharacteristic('heart_rate_measurement');
                    await hrChar.startNotifications();
                    hrChar.addEventListener('characteristicvaluechanged', e => {
                        const v = e.target.value;
                        let hr;
                        const flags = v.getUint8(0);
                        if (flags & 0x01) {
                            hr = v.getUint16(1, true);
                        } else {
                            hr = v.getUint8(1);
                        }
                        heartRateElem.textContent = hr;
                        appendLog(`[HeartRate] ${hr} BPM`);
                    });
                    status.textContent = 'Leyendo Heart Rate...';
                } catch (e) { appendLog('[HR ERROR] ' + e); }

                // ====== Battery Level ======
                try {
                    const batService = await server.getPrimaryService('battery_service');
                    const batChar = await batService.getCharacteristic('battery_level');
                    const batValue = await batChar.readValue();
                    const battery = batValue.getUint8(0);
                    batteryLevelElem.textContent = battery;
                    appendLog(`[Batería] ${battery}%`);
                    // Notificaciones de batería (si soporta)
                    if (batChar.properties.notify) {
                        await batChar.startNotifications();
                        batChar.addEventListener('characteristicvaluechanged', e => {
                            const v = e.target.value;
                            const battery = v.getUint8(0);
                            batteryLevelElem.textContent = battery;
                            appendLog(`[BateríaNotif] ${battery}%`);
                        });
                    }
                } catch (e) { appendLog('[BAT ERROR] ' + e); }

                // ====== Servicio 0x3802 (Unknown) ======
                try {
                    const s3802 = await server.getPrimaryService(0x3802);
                    const char4A02 = await s3802.getCharacteristic(0x4a02);
                    if (char4A02.properties.notify) {
                        await char4A02.startNotifications();
                        char4A02.addEventListener('characteristicvaluechanged', e => {
                            const dv = e.target.value;
                            let bytes = [];
                            for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                            appendLog(`[0x4A02] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                        });
                        status.textContent = 'Leyendo Unknown 0x4A02 (0x3802)...';
                    }
                } catch (e) { appendLog('[3802/4A02 ERROR] ' + e); }

                // ====== Servicio 0xFE86 ======
                try {
                    const sfe86 = await server.getPrimaryService(0xfe86);
                    const chars = await sfe86.getCharacteristics();
                    for (const char of chars) {
                        if (char.properties.notify) {
                            await char.startNotifications();
                            char.addEventListener('characteristicvaluechanged', e => {
                                const dv = e.target.value;
                                let bytes = [];
                                for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                                appendLog(`[0xFE86 ${char.uuid}] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                            });
                        } else if (char.properties.read) {
                            try {
                                const dv = await char.readValue();
                                let bytes = [];
                                for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                                appendLog(`[0xFE86 ${char.uuid} READ] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                            } catch(e) {}
                        }
                    }
                } catch (e) { appendLog('[FE86 ERROR] ' + e); }

                // ====== Servicio UUID largo (Huawei) ======
                try {
                    const sLong = await server.getPrimaryService('cc353442-be58-4ea2-876e-11d8d6976366');
                    const chars = await sLong.getCharacteristics();
                    for (const char of chars) {
                        if (char.properties.notify) {
                            await char.startNotifications();
                            char.addEventListener('characteristicvaluechanged', e => {
                                const dv = e.target.value;
                                let bytes = [];
                                for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                                appendLog(`[LONGUUID ${char.uuid}] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                            });
                        } else if (char.properties.read) {
                            try {
                                const dv = await char.readValue();
                                let bytes = [];
                                for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                                appendLog(`[LONGUUID ${char.uuid} READ] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                            } catch(e) {}
                        }
                    }
                } catch (e) { appendLog('[LONGUUID ERROR] ' + e); }

                // ====== Generic Access & Attribute ======
                try {
                    const gaService = await server.getPrimaryService('generic_access');
                    const gaChars = await gaService.getCharacteristics();
                    for (const char of gaChars) {
                        if (char.properties.read) {
                            try {
                                const dv = await char.readValue();
                                let bytes = [];
                                for (let i = 0; i < dv.byteLength; i++) bytes.push(dv.getUint8(i));
                                appendLog(`[GENERIC_ACCESS ${char.uuid}] ${bytes.map(b => b.toString(16).padStart(2, '0')).join(' ')} | Dec: [${bytes.join(', ')}]`);
                            } catch(e) {}
                        }
                    }
                } catch (e) { appendLog('[GENERIC ACCESS ERROR] ' + e); }

                // ====== Done ======
                status.textContent = "Leyendo todos los datos posibles... (revisa la consola para detalles)";
            } catch (e) {
                status.textContent = 'Error: ' + e;
                connectBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
